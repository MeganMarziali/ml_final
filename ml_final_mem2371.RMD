---
title: "Machine Learning Final"
author: "Megan Marziali"
date: "3/25/2021"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(caret)
library(rpart.plot)
library(Amelia)
library(arsenal)
```

# Part 2: Choose your own supervised adventure

## Research question

The goal of this analysis is to generate hypotheses regarding social capital, nutrient intake and toxic metals during pregnancy on child externalizing and internalizing behaviors. This hypotheses generating analysis will guide future research on the role of social capital, nutrient intake, toxic metals and potential interactions between these features on child behaviors.

## Loading and preparing data

Loading data into single data frame.

```{r dataprep, message = FALSE, warning = FALSE}
#Load data using path of where file is stored
load("./data/exposome.RData")

#Merge all data frames into a single data frame. FYI, this is just a shortcut by combining baseR with piping from tidyverse. There are other ways of merging across three data frames that are likely more elegant.

studydata = 
  merge(exposome,phenotype,by = "ID") %>% 
  merge(covariates, by = "ID")

#Strip off ID Variable
studydata$ID = NULL
```

Data cleaning and selecting relevant features to research question.

```{r message = FALSE, warning = FALSE}
studydata  = studydata %>% 
  select(e3_alcpreg_yn_None,
         h_cereal_preg_Ter,
         h_dairy_preg_Ter,
         h_fastfood_preg_Ter,
         h_fish_preg_Ter,
         h_folic_t1_None,
         h_fruit_preg_Ter,
         h_legume_preg_Ter,
         h_meat_preg_Ter,
         h_veg_preg_Ter,
         hs_as_m_Log2,
         hs_cd_m_Log2,
         hs_co_m_Log2,
         hs_cs_m_Log2,
         hs_cu_m_Log2,
         hs_hg_m_Log2,
         hs_mn_m_Log2,
         hs_mo_m_Log2,
         hs_pb_m_Log2,
         hs_tl_mdich_None,
         hs_dde_madj_Log2,
         hs_ddt_madj_Log2,
         hs_hcb_madj_Log2,
         hs_pcb118_madj_Log2,
         hs_pcb138_madj_Log2,
         hs_pcb153_madj_Log2,
         hs_pcb170_madj_Log2,
         hs_pcb180_madj_Log2,
         hs_sumPCBs5_madj_Log2,
         hs_dep_madj_Log2,
         hs_detp_madj_Log2,
         hs_dmp_madj_Log2,
         hs_dmtp_madj_Log2,
         hs_pbde153_madj_Log2,
         hs_pbde47_madj_Log2,
         hs_pfhxs_m_Log2,
         hs_pfna_m_Log2,
         hs_pfoa_m_Log2,
         hs_pfos_m_Log2,
         hs_pfunda_m_Log2,
         hs_bpa_madj_Log2,
         hs_bupa_madj_Log2,
         hs_etpa_madj_Log2,
         hs_mepa_madj_Log2,
         hs_oxbe_madj_Log2,
         hs_prpa_madj_Log2,
         hs_trcs_madj_Log2,
         hs_mbzp_madj_Log2,
         hs_mecpp_madj_Log2,
         hs_mehhp_madj_Log2,
         hs_mehp_madj_Log2,
         hs_meohp_madj_Log2,
         hs_mep_madj_Log2,
         hs_mibp_madj_Log2,
         hs_mnbp_madj_Log2,
         hs_ohminp_madj_Log2,
         hs_oxominp_madj_Log2,
         hs_sumDEHP_madj_Log2,
         hs_cotinine_mcat_None,
         FAS_cat_None,
         hs_contactfam_3cat_num_None,
         hs_hm_pers_None,
         hs_participation_3cat_None,
         hs_Gen_Tot
         ) 

data.rec = studydata %>% 
  mutate(
    behav = cut(hs_Gen_Tot, 
                breaks = c(-Inf, 60, Inf),
                labels = c("0", "1"))
  ) %>% 
  select(-hs_Gen_Tot) %>% 
  select(everything(), behav)
```

Data exploration.

```{r message = FALSE, warning = FALSE, results = "asis"}
# Investigating missing data
missmap(studydata)

# No missingness observed.

# Exploring continuous/categorical variables of interest
table.1 = tableby(~ hs_asthma + hs_no2_wk_hs_h_log + h_pm_log +
                    h_folic_t1_none + fas_cat_none + hs_hm_pers_none + hs_participation_3cat_none,
                  data = data.rec,
        numeric.stats = c("mean","median", "range"))
summary(table.1, text = TRUE)
```

I chose to explore a few variables related to asthma and air pollution, including NO2 concentration (mean: 2.86, median: 2.98; range: 0.95 - 4.81). I also opted to explore concentration of particulate matter (mean: 2.44; median: 2.30; range: 1.55 - 5.24). Within this sample, 53.4% (N=695) of mothers consumed folic acid during pregnancy. 51.4% (N=669) of mothers scored high on the family affluence score. The median number of people leaving in the home was 4 (range: 1-10). The majority (57.5%, N=748) of mothers did not participate in any organizations.

Partitioning data.

```{r message = FALSE, warning = FALSE}
set.seed(100)

#Partition data for use in demonstration
train.indices = createDataPartition(y = data.rec$hs_asthma, p = 0.7,list = FALSE)
training = data.rec[train.indices, ]
testing = data.rec[-train.indices, ]
```

# Question 2

## Developing research question

Given available data, and the number of features, my research question of interest will be hypothesis generating. This analysis will aim to determine potential risk factors of asthma at 6-11 years old.

# Question 3

## Using LASSO for feature selection

```{r, warning = FALSE, message = FALSE}
set.seed(100)

#Create grid to search lambda
lambda = 10^seq(-3,3, length = 100)

lasso.m = train(
  hs_asthma ~., 
  data = training, 
  method = "glmnet", 
  trControl = trainControl("cv", number = 10, sampling = "down"), 
  tuneGrid = expand.grid(alpha = 0, lambda = lambda)
)

#Print the values of alpha and lambda that gave best prediction
lasso.m$bestTune

#Print all of the options examined
lasso.m$results

# Model coefficients
coef(lasso.m$finalModel, lasso.m$bestTune$lambda)
varImp(lasso.m)

# Make predictions
pred.lasso = predict(lasso.m, training)
pred.lasso.prob = predict(lasso.m, training, type = "prob")

# Model prediction performance
eval.results = confusionMatrix(pred.lasso, training$hs_asthma, positive = "1")
print(eval.results)

#Accuracy of this model is 0.62
```

## Final accuracy testing

```{r message = FALSE, warning = FALSE}
set.seed(100)

# Using best fit model from above with testing data
pred.lasso.f = predict(lasso.m, testing)
pred.lasso.f.prob = predict(lasso.m, testing, type = "prob")

# Evaluating in testing data with confusion matrix
eval.results = confusionMatrix(pred.lasso.f, testing$hs_asthma, positive = "1")
print(eval.results)
```

Final accuracy testing shows that the accuracy of this model is 0.59.

Risk factors show that undetectable thallium levels in the mother is the most important predictor, which tells me that something about this model isn't quite right. Other important predictors of asthma show that PM25 absorbance the year before the examination, fruit and vegetable intake, and PM absorbance.
